#!/bin/bash
#
# glassfish:          Startup script for Glassfish Application Server.

<% glassfish_home = "#{node[:glassfish][:base_dir]}/glassfish" %>

export AS_JAVA=<%= node["java"]["java_home"] %>

start() {
        echo -n "Starting Glassfish Domains: "
<% node[:glassfish][:domains].each do |domain_name| %>
        <% log_file = "#{glassfish_home}/domains/#{domain_name}/logs/startup.log" %>
        echo -n "<%= domain_name %> "
        echo "Starting Glassfish at `date`" >> <%= log_file %>
        su <%= node[:glassfish][:user] %> -c "<%= glassfish_home %>/bin/asadmin start-domain --domaindir <%= node[:glassfish][:domains_dir] %> <%= domain_name %>" >> <%= log_file %>
        sleep 2
<% end %>
    echo "done"
}

stop() {
        echo -n "Stopping Glassfish Domains: "
<% node[:glassfish][:domains].each do |domain_name| %>
        <% log_file = "#{glassfish_home}/domains/#{domain_name}/logs/startup.log" %>
        echo -n "<%= domain_name %> "
        echo "Stopping Glassfish at `date`" >> <%= log_file %>
        su <%= node[:glassfish][:user] %> -c "<%= glassfish_home %>/bin/asadmin stop-domain --domaindir <%= node[:glassfish][:domains_dir] %> <%= domain_name %>" >> <%= log_file %>
<% end %>
        echo "done"
}

case "$1" in
        start)
                start
                ;;
        stop)
                stop
                ;;
        restart)
                stop
                start
                ;;
        *)
                echo $"Usage: glassfish {start|stop|restart}"
                exit
esac
